name: Permissions
description: >
  Actions and content that require specific permissions or roles
  should handle unauthorized access gracefully.

rules:
  - id: gated-action-no-disabled
    name: Restricted action has no disabled/unauthorized state
    severity: warning
    annotation_target: element
    description: >
      Actions that require specific permissions (admin, owner, editor)
      should show a disabled state with explanation for unauthorized users.
    triggers:
      layer_name_patterns:
        - "(?i)(admin|manage|settings|edit|configure|delete|invite|approve)"
      pattern_types:
        - button
    exclude:
      parent_name_patterns: ["(?i)(nav|header|footer|sidebar|menu|toolbar)"]
      screen_name_patterns: ["(?i)(styleguide|design.?system|component.?library)"]
    confidence_signals:
      name_match: 0.5
      component_match: 0.3
      visual_match: 0.2
      threshold: 0.4
    finding_template:
      title: "No disabled state for restricted \"{{element_text}}\" action"
      description: "This action requires specific permissions but has no disabled state. Unauthorized users will see a clickable button that fails silently."
      recommendation: "Add a disabled state with a tooltip explaining which role or permission is needed to use this action."
    expects:
      in_screen:
        - layer_name_patterns: ["(?i)(disabled|unauthorized|forbidden|no.?permission|locked|restricted|read.?only|viewer|can.?t|cannot)"]
        - component_names: ["Tooltip", "Popover"]
      in_flow:
        - layer_name_patterns: ["(?i)(permission|access.?denied|role|unauthorized|forbidden|locked)"]
    recommendation:
      message: >
        Add a disabled state for this action when the user lacks permission.
        Include a tooltip explaining what role/permission is needed.
      components:
        - shadcn_id: button
          variant: disabled
          label: "Disabled Button"
        - shadcn_id: tooltip
          label: "Permission Tooltip"
        - shadcn_id: alert
          label: "Access Denied Alert"

  - id: session-expiry
    name: No session expiry handling
    severity: warning
    annotation_target: screen
    description: >
      Authenticated flows should handle session expiry gracefully —
      especially mid-task. If a user's session times out while filling
      a form or during checkout, their progress should be preserved
      and they should be guided to re-authenticate.
    triggers:
      pattern_types:
        - form
      layer_name_patterns:
        - "(?i)(checkout|payment|account|profile|settings|order|booking)"
    exclude:
      screen_name_patterns: ["(?i)(styleguide|design.?system|component.?library|login|sign.?in|register)"]
    confidence_signals:
      name_match: 0.4
      component_match: 0.2
      visual_match: 0.4
      threshold: 0.4
    finding_template:
      title: "No session expiry handling on {{element_name}} screen"
      description: "This authenticated flow has no session timeout handling. Users may lose form progress if their session expires mid-task."
      recommendation: "Add a session expired modal that prompts re-authentication without losing the user's current form data."
    expects:
      in_flow:
        - layer_name_patterns: ["(?i)(session|expir|timeout|re.?auth|re.?login|sign.?in.?again|token)"]
    recommendation:
      message: >
        Design a session expiry state — show a modal prompting re-authentication
        without losing the user's current form data or progress. Preserve
        state in local storage or session storage as a fallback.
      components:
        - shadcn_id: alert-dialog
          label: "Session Expired Dialog"
        - shadcn_id: button
          label: "Re-authenticate Button"

  - id: guest-vs-authenticated
    name: No guest/unauthenticated experience designed
    severity: warning
    annotation_target: screen
    description: >
      Flows that can be accessed by both guests and signed-in users should
      clearly show both paths. Baymard found 60% of testers had serious
      trouble finding the guest checkout option when it existed.
    triggers:
      layer_name_patterns:
        - "(?i)(checkout|purchase|buy|subscribe|sign.?in|log.?in|account)"
    exclude:
      screen_name_patterns: ["(?i)(styleguide|design.?system|component.?library|admin|dashboard)"]
    confidence_signals:
      name_match: 0.5
      component_match: 0.2
      visual_match: 0.3
      threshold: 0.4
    finding_template:
      title: "No guest path designed for {{flow_context}} flow"
      description: "This flow has no visible guest or unauthenticated path. Users without accounts may abandon the flow entirely."
      recommendation: "Add an equally visible guest option alongside sign-in, and consider progressive account creation after the core task."
    expects:
      in_screen:
        - layer_name_patterns: ["(?i)(guest|continue.?without|skip|no.?account|sign.?in.?later)"]
      in_flow:
        - layer_name_patterns: ["(?i)(guest|unauthenticated|anonymous|sign.?up.?wall)"]
    recommendation:
      message: >
        Design a clear guest path alongside the authenticated flow. Make the
        guest option equally visible — don't bury it below sign-in. Consider
        progressive account creation after the core task is complete.
      components:
        - shadcn_id: button
          label: "Guest Checkout Button"
        - shadcn_id: card
          label: "Account Options Card"

  - id: paywall-upgrade-path
    name: Feature limit has no clear upgrade path
    severity: info
    annotation_target: screen
    description: >
      When users hit a feature paywall or usage limit, the UI should
      clearly explain what's restricted and provide a direct path to
      upgrade — not just block the action with no explanation.
    triggers:
      layer_name_patterns:
        - "(?i)(upgrade|premium|pro|plan|pricing|limit|quota|usage|tier|subscription)"
    exclude:
      screen_name_patterns: ["(?i)(styleguide|design.?system|component.?library)"]
    confidence_signals:
      name_match: 0.5
      component_match: 0.2
      visual_match: 0.3
      threshold: 0.5
    finding_template:
      title: "No clear upgrade path at {{element_name}} feature limit"
      description: "This feature limit or paywall has no visible upgrade CTA. Users hitting the limit will be blocked with no clear next step."
      recommendation: "Add an upgrade prompt explaining the restriction and a direct CTA linking to the pricing or upgrade page."
    expects:
      in_screen:
        - layer_name_patterns: ["(?i)(upgrade|unlock|pricing|plan|subscribe|limit.?reached|quota)"]
      in_flow:
        - layer_name_patterns: ["(?i)(upgrade|paywall|pricing|plan.?select)"]
    recommendation:
      message: >
        Add a clear upgrade prompt when the user hits a feature limit. Explain
        what capability is restricted, why, and provide a direct CTA to the
        upgrade or pricing page.
      components:
        - shadcn_id: alert
          label: "Feature Limit Alert"
        - shadcn_id: button
          label: "Upgrade CTA Button"
        - shadcn_id: card
          label: "Pricing Comparison Card"
